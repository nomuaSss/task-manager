<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Zen Tasks">
  <meta name="theme-color" content="#d4a574">
  <meta name="description" content="Suivi de t√¢ches zen avec timer progressif">
  
  <!-- Icons pour iOS -->
  <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' fill='%23d4a574'/%3E%3Cpath d='M90 40 L90 140 M50 90 L90 130 L130 90' stroke='white' stroke-width='8' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3C/svg%3E">
  
  <!-- Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <title>Zen Task Tracker</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overscroll-behavior-y: none;
    }
    
    #root {
      width: 100%;
      min-height: 100vh;
      position: relative;
    }
    
    /* iOS safe area */
    @supports (padding: max(0px)) {
      body {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
      }
    }
    
    /* Loading screen */
    .loading-screen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #d4a574 0%, #c9956e 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.3s ease;
    }
    
    .loading-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .loading-icon {
      font-size: 4rem;
      animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.1); }
    }
  </style>
</head>
<body>
  <!-- Loading screen -->
  <div class="loading-screen" id="loading">
    <div class="loading-icon">‚ú®</div>
    <div style="color: #8B5C2E; font-family: system-ui; margin-top: 1rem;">Chargement...</div>
  </div>
  
  <!-- React app root -->
  <div id="root"></div>
  
  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('‚úÖ Service Worker enregistr√©'))
          .catch(err => console.log('‚ùå Erreur SW:', err));
      });
    }
  </script>
  
  <!-- React, ReactDOM & Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Lucide React Icons -->
  <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>
  
  <!-- App Code -->
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const { Plus, Settings, RotateCcw, X, TrendingUp, Archive, Undo2 } = lucide;

    function ZenTaskTrackerPro() {
      const [lists, setLists] = useState([{
        id: 1,
        name: 'Mes objectifs',
        startDate: new Date().toISOString().split('T')[0],
        startTime: Date.now(),
        totalUnits: 7,
        unitType: '1j',
        tasks: []
      }]);
      
      const [currentListIndex, setCurrentListIndex] = useState(0);
      const [showSettings, setShowSettings] = useState(false);
      const [showStats, setShowStats] = useState(false);
      const [addingMainTask, setAddingMainTask] = useState(false);
      const [addingSubtask, setAddingSubtask] = useState(null);
      const [newTaskName, setNewTaskName] = useState('');
      const [, forceUpdate] = useState();
      const [loading, setLoading] = useState(true);
      const [undoStack, setUndoStack] = useState([]);
      const [draggedTask, setDraggedTask] = useState(null);
      const [dragOverTask, setDragOverTask] = useState(null);

      const currentList = lists[currentListIndex];

      // Load data from localStorage (fallback if window.storage not available)
      useEffect(() => {
        const loadData = async () => {
          try {
            // Try window.storage first (for artifacts)
            if (window.storage && window.storage.get) {
              const result = await window.storage.get('zenTaskLists');
              if (result && result.value) {
                const loadedLists = JSON.parse(result.value);
                setLists(loadedLists);
              }
            } else {
              // Fallback to localStorage for standalone app
              const saved = localStorage.getItem('zenTaskLists');
              if (saved) {
                setLists(JSON.parse(saved));
              }
            }
          } catch (error) {
            console.log('Premi√®re utilisation ou stockage vide');
          } finally {
            setLoading(false);
            // Hide loading screen
            setTimeout(() => {
              document.getElementById('loading').classList.add('hidden');
            }, 300);
          }
        };
        loadData();
      }, []);

      // Save data
      useEffect(() => {
        if (!loading) {
          const saveData = async () => {
            try {
              if (window.storage && window.storage.set) {
                await window.storage.set('zenTaskLists', JSON.stringify(lists));
              } else {
                localStorage.setItem('zenTaskLists', JSON.stringify(lists));
              }
            } catch (error) {
              console.error('Erreur de sauvegarde:', error);
            }
          };
          saveData();
        }
      }, [lists, loading]);

      // Auto-refresh timer
      useEffect(() => {
        const interval = setInterval(() => forceUpdate({}), 1000);
        return () => clearInterval(interval);
      }, []);

      const haptic = (type = 'light') => {
        if (navigator.vibrate) {
          const patterns = {
            light: 10,
            medium: 20,
            heavy: [10, 30, 10],
            success: [10, 20, 10]
          };
          navigator.vibrate(patterns[type] || 10);
        }
      };

      const getUnitDuration = (unitType) => {
        const units = {
          '5min': 5 * 60 * 1000,
          '1h': 60 * 60 * 1000,
          '1j': 24 * 60 * 60 * 1000,
          '1sem': 7 * 24 * 60 * 60 * 1000,
          '1mois': 30 * 24 * 60 * 60 * 1000
        };
        return units[unitType] || units['1j'];
      };

      const getProgressiveTime = (startTime, totalUnits, unitType) => {
        const now = Date.now();
        const elapsed = now - startTime;
        const unitDuration = getUnitDuration(unitType);
        const totalDuration = unitDuration * totalUnits;
        
        const totalProgress = Math.min(1, elapsed / totalDuration);
        const currentUnitIndex = Math.floor(totalProgress * totalUnits);
        const progressInCurrentUnit = (totalProgress * totalUnits) % 1;
        
        return {
          currentUnitIndex,
          progressInCurrentUnit,
          totalProgress,
          isComplete: totalProgress >= 1
        };
      };

      const getTimeRemaining = (startTime, totalUnits, unitType) => {
        const totalDuration = getUnitDuration(unitType) * totalUnits;
        const endTime = startTime + totalDuration;
        const now = Date.now();
        const remaining = Math.max(0, endTime - now);
        
        const days = Math.floor(remaining / (24 * 60 * 60 * 1000));
        const hours = Math.floor((remaining % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
        const minutes = Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000));
        
        if (days > 0) return `${days}j ${hours}h`;
        if (hours > 0) return `${hours}h ${minutes}m`;
        return `${minutes}m`;
      };

      const isTaskComplete = (task) => {
        if (!task.subtasks || task.subtasks.length === 0) return task.completed;
        return task.subtasks.every(st => isTaskComplete(st));
      };

      const countTasks = (tasks, includeSubtasks = true) => {
        let total = 0;
        let completed = 0;
        
        const count = (taskList) => {
          taskList.forEach(task => {
            total++;
            if (isTaskComplete(task)) completed++;
            if (includeSubtasks && task.subtasks && task.subtasks.length > 0) {
              count(task.subtasks);
            }
          });
        };
        
        count(tasks);
        return { total, completed };
      };

      const saveToUndo = () => {
        setUndoStack(prev => [...prev.slice(-9), JSON.parse(JSON.stringify(lists))]);
      };

      const undo = () => {
        if (undoStack.length > 0) {
          const previous = undoStack[undoStack.length - 1];
          setLists(previous);
          setUndoStack(prev => prev.slice(0, -1));
          haptic('medium');
        }
      };

      const toggleTaskRecursive = (tasks, taskId) => {
        return tasks.map(task => {
          if (task.id === taskId) {
            const newCompleted = !task.completed;
            const updateSubtasks = (subtasks) => {
              return subtasks.map(st => ({
                ...st,
                completed: newCompleted,
                subtasks: st.subtasks ? updateSubtasks(st.subtasks) : []
              }));
            };
            return {
              ...task,
              completed: newCompleted,
              completedAt: newCompleted ? Date.now() : null,
              subtasks: task.subtasks ? updateSubtasks(task.subtasks) : []
            };
          }
          if (task.subtasks && task.subtasks.length > 0) {
            const newSubtasks = toggleTaskRecursive(task.subtasks, taskId);
            const allComplete = newSubtasks.every(st => isTaskComplete(st));
            return {
              ...task,
              subtasks: newSubtasks,
              completed: allComplete,
              completedAt: allComplete ? Date.now() : null
            };
          }
          return task;
        });
      };

      const toggleTask = (taskId) => {
        saveToUndo();
        setLists(prev => {
          const newLists = [...prev];
          newLists[currentListIndex].tasks = toggleTaskRecursive(
            newLists[currentListIndex].tasks,
            taskId
          );
          return newLists;
        });
        haptic('success');
      };

      const addMainTask = () => {
        if (!newTaskName.trim()) return;
        
        saveToUndo();
        setLists(prev => {
          const newLists = [...prev];
          newLists[currentListIndex].tasks.push({
            id: Date.now(),
            name: newTaskName.trim(),
            completed: false,
            createdAt: Date.now(),
            completedAt: null,
            subtasks: []
          });
          return newLists;
        });
        setNewTaskName('');
        setAddingMainTask(false);
        haptic('light');
      };

      const addSubtask = (parentId) => {
        if (!newTaskName.trim()) return;

        saveToUndo();
        const addSubtaskRecursive = (tasks) => {
          return tasks.map(task => {
            if (task.id === parentId) {
              return {
                ...task,
                subtasks: [...task.subtasks, {
                  id: Date.now(),
                  name: newTaskName.trim(),
                  completed: false,
                  createdAt: Date.now(),
                  completedAt: null,
                  subtasks: []
                }]
              };
            }
            if (task.subtasks.length > 0) {
              return {
                ...task,
                subtasks: addSubtaskRecursive(task.subtasks)
              };
            }
            return task;
          });
        };

        setLists(prev => {
          const newLists = [...prev];
          newLists[currentListIndex].tasks = addSubtaskRecursive(
            newLists[currentListIndex].tasks
          );
          return newLists;
        });
        setNewTaskName('');
        setAddingSubtask(null);
        haptic('light');
      };

      const deleteTask = (taskId) => {
        saveToUndo();
        const deleteRecursive = (tasks) => {
          return tasks.filter(t => t.id !== taskId).map(task => ({
            ...task,
            subtasks: task.subtasks ? deleteRecursive(task.subtasks) : []
          }));
        };

        setLists(prev => {
          const newLists = [...prev];
          newLists[currentListIndex].tasks = deleteRecursive(
            newLists[currentListIndex].tasks
          );
          return newLists;
        });
        haptic('heavy');
      };

      const reorderTasks = (tasks, dragId, dropId) => {
        const dragIndex = tasks.findIndex(t => t.id === dragId);
        const dropIndex = tasks.findIndex(t => t.id === dropId);
        
        if (dragIndex === -1 || dropIndex === -1) return tasks;
        
        const newTasks = [...tasks];
        const [draggedItem] = newTasks.splice(dragIndex, 1);
        newTasks.splice(dropIndex, 0, draggedItem);
        
        return newTasks;
      };

      const handleDragStart = (taskId) => {
        setDraggedTask(taskId);
        haptic('light');
      };

      const handleDragOver = (e, taskId) => {
        e.preventDefault();
        setDragOverTask(taskId);
      };

      const handleDrop = (e, dropTaskId) => {
        e.preventDefault();
        if (draggedTask && draggedTask !== dropTaskId) {
          saveToUndo();
          setLists(prev => {
            const newLists = [...prev];
            newLists[currentListIndex].tasks = reorderTasks(
              newLists[currentListIndex].tasks,
              draggedTask,
              dropTaskId
            );
            return newLists;
          });
          haptic('medium');
        }
        setDraggedTask(null);
        setDragOverTask(null);
      };

      const resetTimer = () => {
        saveToUndo();
        setLists(prev => {
          const newLists = [...prev];
          newLists[currentListIndex].startTime = Date.now();
          return newLists;
        });
        haptic('medium');
      };

      const updateParam = (field, value) => {
        saveToUndo();
        setLists(prev => {
          const newLists = [...prev];
          if (field === 'unitType' || field === 'totalUnits') {
            newLists[currentListIndex].startTime = Date.now();
          }
          newLists[currentListIndex][field] = value;
          return newLists;
        });
      };

      const addNewList = () => {
        saveToUndo();
        const newList = {
          id: Date.now(),
          name: `Liste ${lists.length + 1}`,
          startDate: new Date().toISOString().split('T')[0],
          startTime: Date.now(),
          totalUnits: 7,
          unitType: '1j',
          tasks: []
        };
        setLists(prev => [...prev, newList]);
        setCurrentListIndex(lists.length);
        haptic('light');
      };

      const deleteList = () => {
        if (lists.length === 1) {
          alert('Vous devez garder au moins une liste !');
          return;
        }
        if (!confirm(`Supprimer "${currentList.name}" ?`)) return;
        
        saveToUndo();
        setLists(prev => prev.filter((_, i) => i !== currentListIndex));
        setCurrentListIndex(Math.max(0, currentListIndex - 1));
        haptic('heavy');
      };

      const archiveCompleted = () => {
        if (!confirm('Archiver toutes les t√¢ches termin√©es ?')) return;
        
        saveToUndo();
        const filterCompleted = (tasks) => {
          return tasks.filter(t => !isTaskComplete(t)).map(task => ({
            ...task,
            subtasks: task.subtasks ? filterCompleted(task.subtasks) : []
          }));
        };

        setLists(prev => {
          const newLists = [...prev];
          newLists[currentListIndex].tasks = filterCompleted(
            newLists[currentListIndex].tasks
          );
          return newLists;
        });
        haptic('success');
      };

      const formatDate = (dateString) => {
        const date = new Date(dateString);
        return date.toLocaleDateString('fr-FR', { 
          day: 'numeric', 
          month: 'long', 
          year: 'numeric' 
        });
      };

      const renderSubtasks = (subtasks, depth = 0) => {
        if (!subtasks || subtasks.length === 0) return null;

        return (
          <div className="mt-2 space-y-1.5" style={{ marginLeft: `${16 + depth * 12}px` }}>
            {subtasks.map(subtask => (
              <div key={subtask.id}>
                <div className="flex items-center gap-2 group">
                  <div className="w-3 h-0.5 bg-amber-800/20 rounded-full" />
                  
                  <button
                    onClick={() => toggleTask(subtask.id)}
                    onContextMenu={(e) => {
                      e.preventDefault();
                      deleteTask(subtask.id);
                    }}
                    className={`w-4 h-4 rounded border-2 flex-shrink-0 transition-all duration-200 hover:scale-110 active:scale-95 ${
                      isTaskComplete(subtask)
                        ? 'bg-amber-700 border-amber-700 animate-checkBounce'
                        : 'border-amber-900/40 bg-amber-50/80'
                    }`}
                  >
                    {isTaskComplete(subtask) && (
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M3 8L6 11L13 4" stroke="white" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                      </svg>
                    )}
                  </button>

                  <span className={`handwriting text-sm transition-all duration-200 ${
                    isTaskComplete(subtask) ? 'opacity-40 line-through' : 'text-amber-950'
                  }`}>
                    {subtask.name}
                  </span>

                  <button
                    onClick={() => setAddingSubtask(subtask.id)}
                    className="opacity-0 group-hover:opacity-100 transition-all duration-200 ml-auto p-1 hover:bg-amber-900/10 rounded-full hover:rotate-90"
                  >
                    <Plus size={12} />
                  </button>
                </div>
                
                {addingSubtask === subtask.id && (
                  <div className="flex items-center gap-2 mt-1.5 animate-slideDown" style={{ marginLeft: '16px' }}>
                    <input
                      type="text"
                      value={newTaskName}
                      onChange={(e) => setNewTaskName(e.target.value)}
                      onKeyDown={(e) => {
                        if (e.key === 'Enter') addSubtask(subtask.id);
                        if (e.key === 'Escape') {
                          setAddingSubtask(null);
                          setNewTaskName('');
                        }
                      }}
                      placeholder="‚úçÔ∏è Sous-t√¢che"
                      className="handwriting flex-1 px-3 py-1.5 bg-white/90 rounded-xl border border-amber-900/20 focus:outline-none focus:border-amber-700 text-amber-950 text-sm shadow-inner"
                      autoFocus
                    />
                    <button
                      onClick={() => {
                        setAddingSubtask(null);
                        setNewTaskName('');
                      }}
                      className="p-1.5 hover:bg-amber-900/10 rounded-full transition-all hover:rotate-90"
                    >
                      <X size={14} />
                    </button>
                  </div>
                )}
                
                {renderSubtasks(subtask.subtasks, depth + 1)}
              </div>
            ))}
          </div>
        );
      };

      const timeData = getProgressiveTime(currentList.startTime, currentList.totalUnits, currentList.unitType);
      const timeRemaining = getTimeRemaining(currentList.startTime, currentList.totalUnits, currentList.unitType);
      const stats = countTasks(currentList.tasks);
      const progress = stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0;

      if (loading) {
        return null;
      }

      return (
        <div className="min-h-screen bg-craft relative overflow-hidden">
          <div className="fixed inset-0 bg-craft-texture" />
          
          <div className="relative z-10 max-w-xl mx-auto px-4 py-6 pb-24">
            {/* Top Bar */}
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center gap-2">
                {undoStack.length > 0 && (
                  <button
                    onClick={undo}
                    className="p-2 bg-amber-100/80 backdrop-blur-sm rounded-xl shadow-paper hover:shadow-paper-lg transition-all active:scale-95"
                  >
                    <Undo2 size={16} />
                  </button>
                )}
              </div>
              <div className="flex gap-1.5">
                <button
                  onClick={() => setShowStats(!showStats)}
                  className={`p-2 backdrop-blur-sm rounded-xl shadow-paper hover:shadow-paper-lg transition-all active:scale-95 ${
                    showStats ? 'bg-amber-700 text-white' : 'bg-amber-100/80 text-amber-900'
                  }`}
                >
                  <TrendingUp size={16} />
                </button>
                <button
                  onClick={resetTimer}
                  className="p-2 bg-amber-100/80 backdrop-blur-sm rounded-xl shadow-paper hover:shadow-paper-lg transition-all active:scale-95 hover:-rotate-6"
                >
                  <RotateCcw size={16} />
                </button>
                <button
                  onClick={() => setShowSettings(!showSettings)}
                  className="p-2 bg-amber-100/80 backdrop-blur-sm rounded-xl shadow-paper hover:shadow-paper-lg transition-all active:scale-95 hover:rotate-6"
                >
                  {showSettings ? <X size={16} /> : <Settings size={16} />}
                </button>
              </div>
            </div>

            {/* Tabs */}
            {lists.length > 1 && (
              <div className="mb-4 flex items-center gap-2 overflow-x-auto pb-2 scrollbar-hide">
                {lists.map((list, index) => (
                  <button
                    key={list.id}
                    onClick={() => setCurrentListIndex(index)}
                    className={`px-4 py-2 rounded-xl font-medium text-sm whitespace-nowrap transition-all ${
                      index === currentListIndex
                        ? 'bg-amber-700 text-white shadow-glow-amber'
                        : 'bg-amber-100/80 text-amber-900 hover:bg-amber-200/80'
                    }`}
                  >
                    {list.name}
                  </button>
                ))}
                <button
                  onClick={addNewList}
                  className="p-2 bg-amber-100/80 rounded-xl hover:bg-amber-200/80 transition-all flex-shrink-0"
                >
                  <Plus size={18} />
                </button>
              </div>
            )}

            {/* Stats Panel */}
            {showStats && (
              <div className="mb-4 p-4 bg-white/70 backdrop-blur-sm rounded-2xl shadow-paper border border-amber-900/10 animate-popIn">
                <h3 className="handwriting text-xl text-amber-950 mb-3">üìä Statistiques</h3>
                <div className="grid grid-cols-2 gap-3">
                  <div className="p-3 bg-amber-50/50 rounded-xl">
                    <div className="text-2xl font-bold text-amber-900">{stats.completed}/{stats.total}</div>
                    <div className="text-xs text-amber-700">T√¢ches termin√©es</div>
                  </div>
                  <div className="p-3 bg-amber-50/50 rounded-xl">
                    <div className="text-2xl font-bold text-amber-900">{progress}%</div>
                    <div className="text-xs text-amber-700">Progression</div>
                  </div>
                  <div className="p-3 bg-amber-50/50 rounded-xl">
                    <div className="text-lg font-bold text-amber-900">{timeRemaining}</div>
                    <div className="text-xs text-amber-700">Temps restant</div>
                  </div>
                  <div className="p-3 bg-amber-50/50 rounded-xl">
                    <div className="text-lg font-bold text-amber-900">{timeData.currentUnitIndex + 1}/{currentList.totalUnits}</div>
                    <div className="text-xs text-amber-700">Unit√©s √©coul√©es</div>
                  </div>
                </div>
                {stats.completed > 0 && (
                  <button
                    onClick={archiveCompleted}
                    className="w-full mt-3 py-2 bg-gradient-to-r from-amber-600 to-amber-700 text-white rounded-xl font-medium text-sm shadow-glow-amber hover:shadow-glow-amber-lg transition-all flex items-center justify-center gap-2"
                  >
                    <Archive size={14} />
                    Archiver les t√¢ches termin√©es
                  </button>
                )}
              </div>
            )}

            {/* Header */}
            <div className="mb-5">
              <h1 className="handwriting text-3xl text-amber-950 drop-shadow-sm mb-1">
                {currentList.name}
              </h1>
              <div className="text-xs text-amber-800/70 font-medium flex items-center gap-2">
                üìÖ D√©but : {formatDate(currentList.startDate)}
              </div>

              {/* Settings */}
              {showSettings && (
                <div className="mt-3 p-3 bg-white/60 backdrop-blur-sm rounded-2xl shadow-paper border border-amber-900/10 animate-popIn">
                  <input
                    type="text"
                    value={currentList.name}
                    onChange={(e) => updateParam('name', e.target.value)}
                    className="handwriting w-full px-3 py-2 mb-2 bg-amber-50/80 rounded-xl border border-amber-900/20 focus:outline-none focus:border-amber-700 text-base text-amber-950 shadow-inner"
                    placeholder="Nom de la liste"
                  />
                  <div className="mb-2">
                    <label className="text-xs font-medium text-amber-800 mb-1 block">Date de d√©but</label>
                    <input
                      type="date"
                      value={currentList.startDate}
                      onChange={(e) => updateParam('startDate', e.target.value)}
                      className="w-full px-3 py-2 bg-amber-50/80 rounded-xl border border-amber-900/20 focus:outline-none focus:border-amber-700 text-amber-950 shadow-inner"
                    />
                  </div>
                  <div className="flex gap-2 mb-2">
                    <input
                      type="number"
                      value={currentList.totalUnits}
                      onChange={(e) => updateParam('totalUnits', parseInt(e.target.value) || 1)}
                      className="w-16 px-3 py-2 bg-amber-50/80 rounded-xl border border-amber-900/20 text-center focus:outline-none focus:border-amber-700 text-amber-950 shadow-inner"
                      min="1"
                      max="30"
                    />
                    <select
                      value={currentList.unitType}
                      onChange={(e) => updateParam('unitType', e.target.value)}
                      className="flex-1 px-3 py-2 bg-amber-50/80 rounded-xl border border-amber-900/20 focus:outline-none focus:border-amber-700 text-amber-950 shadow-inner"
                    >
                      <option value="5min">5 minutes</option>
                      <option value="1h">1 heure</option>
                      <option value="1j">1 jour</option>
                      <option value="1sem">1 semaine</option>
                      <option value="1mois">1 mois</option>
                    </select>
                  </div>
                  {lists.length > 1 && (
                    <button
                      onClick={deleteList}
                      className="w-full py-2 bg-red-50 hover:bg-red-100 text-red-700 rounded-xl font-medium text-sm transition-all"
                    >
                      üóëÔ∏è Supprimer cette liste
                    </button>
                  )}
                </div>
              )}

              {/* Timer */}
              <div className="mt-3 p-3 bg-white/60 backdrop-blur-sm rounded-2xl shadow-paper border border-amber-900/10">
                <div className="flex items-center justify-between mb-2">
                  <div className="text-[10px] font-bold text-amber-800 tracking-widest">PROGRESSION</div>
                  <div className="text-xs font-bold text-amber-900">{progress}% ‚Ä¢ {timeRemaining}</div>
                </div>
                
                <div className="flex gap-1.5 mb-2">
                  {Array.from({ length: currentList.totalUnits }).map((_, index) => {
                    if (index < timeData.currentUnitIndex) {
                      return (
                        <div
                          key={index}
                          className="flex-1 h-10 rounded-lg transition-all duration-500 border-2 bg-gradient-to-t from-amber-700 via-amber-600 to-amber-500 border-amber-800 shadow-glow-amber"
                        />
                      );
                    }
                    
                    if (index === timeData.currentUnitIndex && !timeData.isComplete) {
                      return (
                        <div
                          key={index}
                          className="flex-1 h-10 rounded-lg border-2 border-amber-800 bg-amber-50/50 overflow-hidden relative"
                        >
                          <div 
                            className="absolute inset-0 bg-gradient-to-t from-amber-700 via-amber-600 to-amber-500 transition-all duration-1000 shadow-glow-amber"
                            style={{ 
                              transform: `scaleY(${timeData.progressInCurrentUnit})`,
                              transformOrigin: 'bottom'
                            }}
                          />
                        </div>
                      );
                    }
                    
                    return (
                      <div
                        key={index}
                        className="flex-1 h-10 rounded-lg transition-all duration-500 border-2 bg-amber-50/50 border-amber-900/20"
                      />
                    );
                  })}
                </div>
                
                <div className="h-2 bg-amber-100/50 rounded-full overflow-hidden">
                  <div 
                    className="h-full bg-gradient-to-r from-amber-600 to-amber-700 transition-all duration-1000 shadow-glow-amber"
                    style={{ width: `${progress}%` }}
                  />
                </div>
              </div>
            </div>

            {/* Tasks */}
            <div className="space-y-3">
              {currentList.tasks.map((task, index) => (
                <div 
                  key={task.id}
                  draggable
                  onDragStart={() => handleDragStart(task.id)}
                  onDragOver={(e) => handleDragOver(e, task.id)}
                  onDrop={(e) => handleDrop(e, task.id)}
                  onDragEnd={() => {
                    setDraggedTask(null);
                    setDragOverTask(null);
                  }}
                  className={`p-3.5 bg-white/60 backdrop-blur-sm rounded-2xl shadow-paper border transition-all group animate-slideInStagger cursor-move ${
                    dragOverTask === task.id && draggedTask !== task.id
                      ? 'border-amber-700 scale-105 shadow-paper-lg'
                      : 'border-amber-900/10 hover:shadow-paper-lg'
                  }`}
                  style={{ animationDelay: `${index * 50}ms` }}
                >
                  <div className="flex items-start gap-3">
                    <button
                      onClick={() => toggleTask(task.id)}
                      onContextMenu={(e) => {
                        e.preventDefault();
                        if (confirm('Supprimer cette t√¢che ?')) {
                          deleteTask(task.id);
                        }
                      }}
                      className={`w-7 h-7 rounded-lg border-2 flex-shrink-0 transition-all duration-200 transform hover:scale-110 active:scale-95 ${
                        isTaskComplete(task)
                          ? 'bg-amber-700 border-amber-800 shadow-glow-amber animate-checkBounce'
                          : 'border-amber-900/40 bg-amber-50/80 hover:border-amber-700'
                      }`}
                    >
                      {isTaskComplete(task) && (
                        <svg width="28" height="28" viewBox="0 0 28 28" fill="none">
                          <path d="M7 14L11 18L21 8" stroke="white" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/>
                        </svg>
                      )}
                    </button>

                    <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-2 mb-0.5">
                        <span className={`handwriting text-lg transition-all duration-200 ${
                          isTaskComplete(task) ? 'opacity-40 line-through' : 'text-amber-950'
                        }`}>
                          {task.name}
                        </span>
                        
                        <button
                          onClick={() => setAddingSubtask(task.id)}
                          className="opacity-0 group-hover:opacity-100 transition-all duration-200 ml-auto p-1.5 hover:bg-amber-900/10 rounded-full hover:rotate-90"
                        >
                          <Plus size={14} />
                        </button>
                      </div>

                      {addingSubtask === task.id && (
                        <div className="flex items-center gap-2 mt-2 mb-1.5 animate-slideDown">
                          <input
                            type="text"
                            value={newTaskName}
                            onChange={(e) => setNewTaskName(e.target.value)}
                            onKeyDown={(e) => {
                              if (e.key === 'Enter') addSubtask(task.id);
                              if (e.key === 'Escape') {
                                setAddingSubtask(null);
                                setNewTaskName('');
                              }
                            }}
                            placeholder="‚úçÔ∏è Sous-t√¢che"
                            className="handwriting flex-1 px-3 py-1.5 bg-amber-50/80 rounded-xl border border-amber-900/20 focus:outline-none focus:border-amber-700 text-amber-950 shadow-inner"
                            autoFocus
                          />
                          <button
                            onClick={() => {
                              setAddingSubtask(null);
                              setNewTaskName('');
                            }}
                            className="p-1.5 hover:bg-amber-900/10 rounded-full transition-all hover:rotate-90"
                          >
                            <X size={14} />
                          </button>
                        </div>
                      )}

                      {renderSubtasks(task.subtasks)}
                    </div>
                  </div>
                </div>
              ))}

              {/* Add Task Button */}
              {addingMainTask ? (
                <div className="p-3.5 bg-gradient-to-br from-amber-100/70 to-orange-100/70 backdrop-blur-sm rounded-2xl shadow-paper border border-amber-900/20 animate-popIn">
                  <div className="flex items-center gap-2">
                    <input
                      type="text"
                      value={newTaskName}
                      onChange={(e) => setNewTaskName(e.target.value)}
                      onKeyDown={(e) => {
                        if (e.key === 'Enter') addMainTask();
                        if (e.key === 'Escape') {
                          setAddingMainTask(false);
                          setNewTaskName('');
                        }
                      }}
                      placeholder="‚úçÔ∏è Nouvelle t√¢che"
                      className="handwriting flex-1 px-3 py-2 bg-white/90 rounded-xl border border-amber-900/20 focus:outline-none focus:border-amber-700 text-amber-950 text-base shadow-inner"
                      autoFocus
                    />
                    <button
                      onClick={() => {
                        setAddingMainTask(false);
                        setNewTaskName('');
                      }}
                      className="p-2 hover:bg-amber-900/10 rounded-full transition-all hover:rotate-90"
                    >
                      <X size={18} />
                    </button>
                  </div>
                </div>
              ) : (
                <button
                  onClick={() => setAddingMainTask(true)}
                  className="w-full py-4 bg-gradient-to-br from-amber-100/70 to-orange-100/70 backdrop-blur-sm rounded-2xl border-2 border-dashed border-amber-700/40 hover:border-amber-700 hover:from-amber-100 hover:to-orange-100 transition-all shadow-paper hover:shadow-paper-lg flex items-center justify-center gap-2 text-amber-900 active:scale-98 group"
                >
                  <Plus size={20} strokeWidth={2.5} className="group-hover:rotate-90 transition-transform duration-200" />
                  <span className="font-bold tracking-wide text-sm">NOUVELLE T√ÇCHE</span>
                </button>
              )}
            </div>

            {/* Hints */}
            <div className="mt-6 space-y-2">
              <div className="text-center text-[10px] text-amber-800/60 font-medium tracking-wide">
                ‚ú® APPUI LONG POUR SUPPRIMER
              </div>
              <div className="text-center text-[10px] text-amber-800/60 font-medium tracking-wide">
                üñêÔ∏è GLISSER-D√âPOSER POUR R√âORGANISER
              </div>
            </div>

            {/* New List Button */}
            {lists.length === 1 && (
              <div className="mt-4">
                <button
                  onClick={addNewList}
                  className="w-full py-3 bg-amber-50/50 backdrop-blur-sm rounded-2xl border-2 border-dashed border-amber-700/30 hover:border-amber-700 hover:bg-amber-100/50 transition-all flex items-center justify-center gap-2 text-amber-800"
                >
                  <Plus size={16} strokeWidth={2.5} />
                  <span className="text-xs font-bold tracking-wide">CR√âER UNE NOUVELLE LISTE</span>
                </button>
              </div>
            )}
          </div>

          <style>{`
            @import url('https://fonts.googleapis.com/css2?family=Caveat:wght@500;600;700&display=swap');
            
            * {
              -webkit-tap-highlight-color: transparent;
            }
            
            .handwriting {
              font-family: 'Caveat', cursive;
              font-weight: 600;
              letter-spacing: 0.01em;
            }
            
            .bg-craft {
              background: linear-gradient(135deg, #d4a574 0%, #c9956e 100%);
            }
            
            .bg-craft-texture {
              background-image: 
                url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='2.5' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.35'/%3E%3C/svg%3E"),
                repeating-linear-gradient(0deg, transparent, transparent 23px, rgba(139, 92, 46, 0.12) 23px, rgba(139, 92, 46, 0.12) 24px),
                radial-gradient(circle at 20% 30%, rgba(139, 92, 46, 0.08) 0%, transparent 3%),
                radial-gradient(circle at 80% 70%, rgba(139, 92, 46, 0.06) 0%, transparent 4%),
                radial-gradient(circle at 40% 80%, rgba(139, 92, 46, 0.07) 0%, transparent 2%),
                radial-gradient(circle at 60% 20%, rgba(139, 92, 46, 0.05) 0%, transparent 3%);
              background-color: #e8d5c4;
              background-blend-mode: multiply;
            }
            
            .shadow-paper {
              box-shadow: 0 1px 3px rgba(92, 64, 35, 0.15), 0 2px 8px rgba(92, 64, 35, 0.08), inset 0 0 0 1px rgba(255, 255, 255, 0.3);
            }
            
            .shadow-paper-lg {
              box-shadow: 0 3px 6px rgba(92, 64, 35, 0.18), 0 4px 12px rgba(92, 64, 35, 0.12), inset 0 0 0 1px rgba(255, 255, 255, 0.4);
            }
            
            .shadow-glow-amber {
              box-shadow: 0 2px 8px rgba(180, 83, 9, 0.25), 0 0 12px rgba(217, 119, 6, 0.15);
            }
            
            .shadow-glow-amber-lg {
              box-shadow: 0 3px 10px rgba(180, 83, 9, 0.35), 0 0 16px rgba(217, 119, 6, 0.25);
            }
            
            @keyframes popIn {
              0% { opacity: 0; transform: scale(0.8) rotate(-3deg); }
              60% { transform: scale(1.05) rotate(1deg); }
              100% { opacity: 1; transform: scale(1) rotate(0deg); }
            }
            
            @keyframes slideDown {
              0% { opacity: 0; transform: translateY(-12px) rotate(-2deg); max-height: 0; }
              100% { opacity: 1; transform: translateY(0) rotate(0deg); max-height: 200px; }
            }
            
            @keyframes checkBounce {
              0% { transform: scale(0) rotate(-45deg); }
              50% { transform: scale(1.2) rotate(5deg); }
              70% { transform: scale(0.9) rotate(-3deg); }
              100% { transform: scale(1) rotate(0deg); }
            }
            
            @keyframes slideInStagger {
              0% { opacity: 0; transform: translateX(-20px) rotate(-2deg); }
              100% { opacity: 1; transform: translateX(0) rotate(0deg); }
            }
            
            .animate-popIn { animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
            .animate-slideDown { animation: slideDown 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
            .animate-checkBounce { animation: checkBounce 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
            .animate-slideInStagger { animation: slideInStagger 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
            
            .active\\:scale-98:active { transform: scale(0.98); }
            .active\\:scale-95:active { transform: scale(0.95); }
            
            .scrollbar-hide {
              -ms-overflow-style: none;
              scrollbar-width: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
              display: none;
            }
            
            @supports (padding: max(0px)) {
              .max-w-xl {
                padding-left: max(1rem, env(safe-area-inset-left));
                padding-right: max(1rem, env(safe-area-inset-right));
              }
            }
            
            @media (max-width: 640px) {
              button, input, select {
                min-height: 44px;
              }
            }
            
            @media (prefers-reduced-motion: reduce) {
              * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
              }
            }
          `}</style>
        </div>
      );
    }

    // Mount React app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<ZenTaskTrackerPro />);
  </script>
</body>
</html>
